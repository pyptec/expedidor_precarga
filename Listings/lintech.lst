C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 09:24:08 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE LINTECH
OBJECT MODULE PLACED IN .\Objects\lintech.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE lintech.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\List
                    -ings\lintech.lst) TABS(2) OBJECT(.\Objects\lintech.obj)

line level    source

   1          #include<lintech.h>
   2          /*----------------------------------------------------------------------------
   3          tiempo de delay entre funciones
   4          ------------------------------------------------------------------------------*/
   5          
   6          #define   TIME_CARD         100   //50
   7          
   8          /*----------------------------------------------------------------------------
   9          definicion de datos de trama lintech
  10          ------------------------------------------------------------------------------*/
  11          
  12          #define   ETX               03
  13          #define   STX_LINTECH       0xf2
  14          /*------------------------------------------------------------------------------
  15          Definicion de Lintech en el comando Inicializa
  16          ------------------------------------------------------------------------------*/
  17          
  18          #define TO_FRONT        '0'
  19          #define CAPTURE_BOX     '1'
  20          #define SIN_MOVIMIENTO  '3'
  21          
  22          /*------------------------------------------------------------------------------
  23           definiciones de lintech en el comando Card_Insercion
  24          ------------------------------------------------------------------------------*/
  25          
  26          #define Habilita        0x30
  27          #define Inhabilita      0x31
  28          
  29          /*------------------------------------------------------------------------------
  30          Definicion de Lintech en el comando mover tarjeta (Mov_Card)
  31          ------------------------------------------------------------------------------*/
  32          
  33          #define   MovPos_Front        '0'   
  34          #define   MovPos_IC           '1'
  35          #define   MovPos_RF           '2'
  36          #define   MovPos_Capture      '3'
  37          #define   MovPos_EjectFront   '9'
  38          
  39          
  40          /*----------------------------------------------------------------------------
  41          definicion de recepcion serial 
  42          ------------------------------------------------------------------------------*/
  43          
  44          #define  ESPERA_RX          0           //espera el primer cmd de recepcion del verificado 
  45          
  46          
  47          /*funciones portotipo*/
  48          extern void Debug_txt_Tibbo(unsigned char * str);
  49          extern void DebugBufferMF(unsigned char *str,unsigned char num_char,char io);
  50          extern void EscribirCadenaSoft_buffer(unsigned char *buffer,unsigned char tamano_cadena);
  51          extern void Debug_chr_Tibbo(unsigned char Dat);
  52          extern unsigned char Dir_board();
  53          
  54          /*atributos */
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 09:24:08 PAGE 2   

  55          extern unsigned char g_cEstadoComSoft;
  56          extern unsigned char ValTimeOutCom;
  57          
  58          /*externo bit*/
  59          
  60          extern bit buffer_ready;
  61          /*----------------------------------------------------------------------------
  62          funcion de inicializacion del transporte
  63          
  64          ------------------------------------------------------------------------------*/
  65          
  66          void Inicializa(unsigned char TipoMovimiento)
  67          {
  68   1        unsigned char j, bcc;
  69   1        unsigned char g_scArrTxComSoft[10];
  70   1        bcc=0;
  71   1        if ((TipoMovimiento==SIN_MOVIMIENTO)||(TipoMovimiento==TO_FRONT)||(TipoMovimiento==CAPTURE_BOX))
  72   1        {
  73   2          
  74   2          Debug_txt_Tibbo((unsigned char *) "Inicializa Dispensador\r\n\r\n");
  75   2          
  76   2          g_scArrTxComSoft[0]=STX_LINTECH;
  77   2          g_scArrTxComSoft[1]=0X00;
  78   2          g_scArrTxComSoft[2]=0X00;
  79   2          g_scArrTxComSoft[3]=0X03;
  80   2          g_scArrTxComSoft[4]='C';
  81   2          g_scArrTxComSoft[5]='0';
  82   2          g_scArrTxComSoft[6]=TipoMovimiento;
  83   2          g_scArrTxComSoft[7]=ETX;
  84   2          for (j=0; j<8; j++)
  85   2          {
  86   3            bcc=g_scArrTxComSoft[j]^bcc;
  87   3          }
  88   2          g_scArrTxComSoft[8]=bcc;
  89   2          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
  90   2          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
  91   2          DebugBufferMF(g_scArrTxComSoft,9,0);                /*muestra la trama enviada al pto serie a debug por tibbo*/
  92   2          EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);    /* envio la trama por el pto serie*/
  93   2          ValTimeOutCom=TIME_CARD;
  94   2        }
  95   1      }
  96          
  97          /*------------------------------------------------------------------------------
  98          cmd de lintech que responde en que estado de los sensores se encuentra
  99          
 100          (30) solo envia el resumen de los sensores
 101          (31) da un reporte detallado de los sensores
 102          S_DETAIL        0x31
 103          S_NORMAL        0x30
 104          detalle=s_detail
 105          ------------------------------------------------------------------------------*/
 106          
 107          void Check_Status(unsigned char Detalle)
 108          {
 109   1        unsigned char j, bcc;
 110   1        unsigned char g_scArrTxComSoft[10];
 111   1        Debug_txt_Tibbo((unsigned char *) "Check_Status\r\n");
 112   1      
 113   1        bcc=0;
 114   1      
 115   1        g_scArrTxComSoft[0]=STX_LINTECH;
 116   1        g_scArrTxComSoft[1]=0X00;
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 09:24:08 PAGE 3   

 117   1        g_scArrTxComSoft[2]=0X00;
 118   1        g_scArrTxComSoft[3]=0X03;
 119   1        g_scArrTxComSoft[4]='C';
 120   1        g_scArrTxComSoft[5]='1';
 121   1        g_scArrTxComSoft[6]=Detalle;
 122   1        g_scArrTxComSoft[7]=ETX;
 123   1        for (j=0; j<8; j++)
 124   1        {
 125   2          bcc=g_scArrTxComSoft[j]^bcc;
 126   2        }
 127   1        g_scArrTxComSoft[8]=bcc;
 128   1        buffer_ready=0;
 129   1        g_cEstadoComSoft=ESPERA_RX;
 130   1        DebugBufferMF(g_scArrTxComSoft,9,0);
 131   1        EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);
 132   1        ValTimeOutCom=TIME_CARD;
 133   1      }
 134          
 135          /*------------------------------------------------------------------------------
 136          Procedimiento que habilita la insercion o inhabilita la insersion
 137          (31) inhabilita
 138          (30) habilita
 139          tipo=1 habilita la insercion de tarjeta
 140          tipo=0 inhabilita la insersion
 141          ------------------------------------------------------------------------------*/
 142          
 143          void Card_Insercion(char Tipo)
 144          {
 145   1        unsigned char j, bcc;
 146   1        unsigned char g_scArrTxComSoft[10];
 147   1        if (Tipo==Habilita)
 148   1        {
 149   2          Debug_txt_Tibbo((unsigned char *) "Habilita Insersion\r\n");
 150   2          g_scArrTxComSoft[6]=Habilita;
 151   2        }
 152   1        else
 153   1        {
 154   2          
 155   2          Debug_txt_Tibbo((unsigned char *) "Inhabilita Insersion\r\n");
 156   2          g_scArrTxComSoft[6]=Inhabilita;
 157   2        
 158   2        }
 159   1      
 160   1        bcc=0;
 161   1      
 162   1        g_scArrTxComSoft[0]=0xF2;
 163   1        g_scArrTxComSoft[1]=0X00;
 164   1        g_scArrTxComSoft[2]=0X00;
 165   1        g_scArrTxComSoft[3]=0X03;
 166   1        g_scArrTxComSoft[4]='C';
 167   1        g_scArrTxComSoft[5]='3';
 168   1      
 169   1        g_scArrTxComSoft[7]=ETX;
 170   1        for (j=0; j<8; j++)
 171   1        {
 172   2          bcc=g_scArrTxComSoft[j]^bcc;
 173   2        }
 174   1      
 175   1        g_scArrTxComSoft[8]=bcc;
 176   1      
 177   1        buffer_ready=0;
 178   1        g_cEstadoComSoft=ESPERA_RX;
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 09:24:08 PAGE 4   

 179   1        DebugBufferMF(g_scArrTxComSoft,9,0);
 180   1        EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);
 181   1        ValTimeOutCom=TIME_CARD;
 182   1      }
 183          
 184          /*------------------------------------------------------------------------------
 185          CMD q mueve la tarjeta 
 186            MovPos_Front        '0'   
 187            MovPos_IC           '1'
 188            MovPos_RF           '2'
 189            MovPos_Capture      '3'
 190            MovPos_EjectFront   '9'
 191          ------------------------------------------------------------------------------*/
 192          
 193          void Mov_Card(unsigned char Posicion)
 194          {
 195   1        unsigned char j, bcc;
 196   1        unsigned char g_scArrTxComSoft[10];
 197   1        bcc=0;
 198   1      
 199   1        if ((Posicion==MovPos_RF)||(Posicion==MovPos_IC)||(Posicion==MovPos_Front)||(Posicion==MovPos_EjectFront
             -)||(Posicion==MovPos_Capture))
 200   1        {
 201   2          if (Posicion==MovPos_RF)
 202   2          {
 203   3            Debug_txt_Tibbo((unsigned char *) "Moviendo Tarjeta a RF\r\n");
 204   3          }
 205   2          else if (Posicion==MovPos_IC)
 206   2          {
 207   3            Debug_txt_Tibbo((unsigned char *) "Moviendo Tarjeta a IC\\r\n");
 208   3            }
 209   2          else if (Posicion==MovPos_Front)
 210   2          {
 211   3            Debug_txt_Tibbo((unsigned char *) "Moviendo Tarjeta a Bezel\r\n");
 212   3          }
 213   2          else if (Posicion==MovPos_EjectFront)
 214   2          {
 215   3            Debug_txt_Tibbo((unsigned char *) "Expulsando Tarjeta\r\n");
 216   3          }
 217   2          else if (Posicion==MovPos_Capture)
 218   2          {
 219   3            Debug_txt_Tibbo((unsigned char *) "Capturando Tarjeta\r\n");
 220   3          }
 221   2      
 222   2          g_scArrTxComSoft[0]=STX_LINTECH;
 223   2          g_scArrTxComSoft[1]=0X00;
 224   2          g_scArrTxComSoft[2]=0X00;
 225   2          g_scArrTxComSoft[3]=0X03;
 226   2          g_scArrTxComSoft[4]='C';
 227   2          g_scArrTxComSoft[5]='2';
 228   2          g_scArrTxComSoft[6]=Posicion;
 229   2          g_scArrTxComSoft[7]=ETX;
 230   2          for (j=0; j<8; j++)
 231   2          {
 232   3            bcc=g_scArrTxComSoft[j]^bcc;
 233   3          }
 234   2          g_scArrTxComSoft[8]=bcc;
 235   2          buffer_ready=0;
 236   2          g_cEstadoComSoft=ESPERA_RX;
 237   2          DebugBufferMF(g_scArrTxComSoft,9,0);
 238   2          EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);
 239   2          ValTimeOutCom=TIME_CARD;
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 09:24:08 PAGE 5   

 240   2        }
 241   1      
 242   1      }
 243          
 244          //*******************************************************************************************
 245          // rutina q mira el tipo de tarjeta si es valido para el uso  
 246          //*******************************************************************************************
 247          
 248          void Aut_Card_check_Status(void)
 249          {
 250   1      unsigned char j, bcc;
 251   1      unsigned char g_scArrTxComSoft[10];
 252   1            bcc=0;
 253   1        
 254   1        Debug_txt_Tibbo((unsigned char *) "Aut_Card_check_Status\r\n");
 255   1        
 256   1        g_scArrTxComSoft[0]=STX_LINTECH;
 257   1          g_scArrTxComSoft[1]=0X00;
 258   1          g_scArrTxComSoft[2]=0X00;
 259   1          g_scArrTxComSoft[3]=0X03;
 260   1          g_scArrTxComSoft[4]='C';
 261   1          g_scArrTxComSoft[5]=0x50;
 262   1          g_scArrTxComSoft[6]=0x31;
 263   1          g_scArrTxComSoft[7]=ETX;
 264   1            for (j=0; j<8; j++)
 265   1          {
 266   2            bcc=g_scArrTxComSoft[j]^bcc;
 267   2          }
 268   1          g_scArrTxComSoft[8]=bcc;
 269   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 270   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 271   1          DebugBufferMF(g_scArrTxComSoft,9,0);                /*muestra la trama enviada al pto serie a debug por tibbo*/
 272   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);    /* envio la trama por el pto serie*/
 273   1          ValTimeOutCom=TIME_CARD;
 274   1        } 
 275          /*  ------------------------------------------------------------------------------
 276            ------------------------------------------------------------------------------*/
 277          void Clave_Seguridad_S2(void)
 278          {
 279   1        unsigned char j, bcc;
 280   1        unsigned char g_scArrTxComSoft[21];
 281   1            bcc=0;
 282   1        Debug_txt_Tibbo((unsigned char *) "Clave Seguridad S2\r\n");
 283   1      
 284   1      
 285   1        g_scArrTxComSoft[0]=STX_LINTECH;
 286   1        g_scArrTxComSoft[1]=0X00;
 287   1        g_scArrTxComSoft[2]=0X00;
 288   1        g_scArrTxComSoft[3]=0X0e; // Numero Datos
 289   1        g_scArrTxComSoft[4]='C';
 290   1        g_scArrTxComSoft[5]=0x60;
 291   1        g_scArrTxComSoft[6]='3';
 292   1        g_scArrTxComSoft[7]=0x00;
 293   1        g_scArrTxComSoft[8]=0x20;
 294   1          g_scArrTxComSoft[9]=0x00;
 295   1        g_scArrTxComSoft[10]=0x02;
 296   1      
 297   1        g_scArrTxComSoft[11]=0x06;
 298   1      
 299   1        g_scArrTxComSoft[12]=0x41;
 300   1        g_scArrTxComSoft[13]=0x63;
 301   1        g_scArrTxComSoft[14]=0x53;
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 09:24:08 PAGE 6   

 302   1          g_scArrTxComSoft[15]=0x45;
 303   1        g_scArrTxComSoft[16]=0x76;
 304   1        g_scArrTxComSoft[17]=0x50;
 305   1      
 306   1      
 307   1        g_scArrTxComSoft[18]=ETX;
 308   1        
 309   1          for (j=0; j<19; j++)
 310   1          {
 311   2            bcc=g_scArrTxComSoft[j]^bcc;
 312   2          }
 313   1          g_scArrTxComSoft[19]=bcc;
 314   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 315   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 316   1          DebugBufferMF(g_scArrTxComSoft,20,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 317   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,20);   /* envio la trama por el pto serie*/
 318   1          ValTimeOutCom=TIME_CARD;
 319   1        
 320   1      
 321   1      }
 322          /*------------------------------------------------------------------------------
 323          CMD q programa la clave en el verificador o transporte
 324          ------------------------------------------------------------------------------*/
 325          
 326            void Dwload_EEprom (void)
 327          {
 328   1        unsigned char j, bcc;
 329   1        unsigned char g_scArrTxComSoft[21];
 330   1        bcc=0;
 331   1        Debug_txt_Tibbo((unsigned char *) "Download MF EEprom\r\n");
 332   1        
 333   1        g_scArrTxComSoft[0]=0xF2;
 334   1        g_scArrTxComSoft[1]=0X00;
 335   1        g_scArrTxComSoft[2]=0X00;
 336   1        g_scArrTxComSoft[3]=0X0E;
 337   1        g_scArrTxComSoft[4]='C';
 338   1        g_scArrTxComSoft[5]=0x60;
 339   1        g_scArrTxComSoft[6]='3';
 340   1        g_scArrTxComSoft[7]=0x00;
 341   1        g_scArrTxComSoft[8]=0Xd0;
 342   1        g_scArrTxComSoft[9]=0X00;
 343   1        g_scArrTxComSoft[10]=0X01;
 344   1        g_scArrTxComSoft[11]=0x06;
 345   1        g_scArrTxComSoft[12]='3'; //33
 346   1        g_scArrTxComSoft[13]='V';//56
 347   1        g_scArrTxComSoft[14]='0';//30
 348   1        g_scArrTxComSoft[15]='p';//70
 349   1        g_scArrTxComSoft[16]='4';//34
 350   1        g_scArrTxComSoft[17]='r';//72
 351   1        g_scArrTxComSoft[18]=ETX;
 352   1        
 353   1        for (j=0; j<19; j++)
 354   1          {
 355   2            bcc=g_scArrTxComSoft[j]^bcc;
 356   2          }
 357   1          g_scArrTxComSoft[19]=bcc;
 358   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 359   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 360   1          DebugBufferMF(g_scArrTxComSoft,20,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 361   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,20);   /* envio la trama por el pto serie*/
 362   1          ValTimeOutCom=TIME_CARD;
 363   1      }
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 09:24:08 PAGE 7   

 364          
 365          /*------------------------------------------------------------------------------
 366          Funcion q verifica si la clave y la carga en el transporte
 367          ------------------------------------------------------------------------------*/
 368          
 369          void LoadVerify_EEprom(void)
 370          {
 371   1        unsigned char j, bcc;
 372   1        unsigned char g_scArrTxComSoft[15];
 373   1        bcc=0;
 374   1        Debug_txt_Tibbo((unsigned char *) "Carga y Verifica de EEprom\r\n");
 375   1      
 376   1      
 377   1        g_scArrTxComSoft[0]=0xF2;
 378   1        g_scArrTxComSoft[1]=0X00;
 379   1        g_scArrTxComSoft[2]=0X00;
 380   1        g_scArrTxComSoft[3]=0X07;
 381   1        g_scArrTxComSoft[4]='C';
 382   1        g_scArrTxComSoft[5]=0x60;
 383   1        g_scArrTxComSoft[6]='3';
 384   1        g_scArrTxComSoft[7]=0x00;
 385   1        g_scArrTxComSoft[8]=0x21;
 386   1        g_scArrTxComSoft[9]=0x00;
 387   1        g_scArrTxComSoft[10]=0x01;
 388   1        g_scArrTxComSoft[11]=ETX;
 389   1        g_scArrTxComSoft[12]=0xc6;
 390   1      
 391   1        
 392   1      
 393   1        for (j=0; j<13; j++)
 394   1          {
 395   2            bcc=g_scArrTxComSoft[j]^bcc;
 396   2          }
 397   1          g_scArrTxComSoft[13]=bcc;
 398   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 399   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 400   1          DebugBufferMF(g_scArrTxComSoft,14,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 401   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,14);   /* envio la trama por el pto serie*/
 402   1          ValTimeOutCom=TIME_CARD;
 403   1          
 404   1      }
 405          
 406          /*------------------------------------------------------------------------------
 407          Funcion q lee la MF dandole el sector y el bloque
 408          ------------------------------------------------------------------------------*/
 409          
 410          void RD_MF(unsigned char Sector, unsigned char Bloque)
 411          {
 412   1      
 413   1        unsigned char j, bcc;
 414   1        unsigned char g_scArrTxComSoft[15];
 415   1        bcc=0;
 416   1      
 417   1        Debug_txt_Tibbo((unsigned char *) "Leyendo MF > Sector: ");
 418   1        Debug_chr_Tibbo(Sector);
 419   1        
 420   1        Debug_txt_Tibbo((unsigned char *) " Bloque: ");
 421   1        Debug_chr_Tibbo(Bloque);
 422   1        Debug_txt_Tibbo((unsigned char *) "\r\n");
 423   1      
 424   1      
 425   1        g_scArrTxComSoft[0]=0xF2;
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 09:24:08 PAGE 8   

 426   1        g_scArrTxComSoft[1]=0X00;                   
 427   1        g_scArrTxComSoft[2]=0X00;
 428   1        g_scArrTxComSoft[3]=0X08;
 429   1        g_scArrTxComSoft[4]='C';
 430   1        g_scArrTxComSoft[5]=0X60;
 431   1        g_scArrTxComSoft[6]='3';
 432   1        g_scArrTxComSoft[7]=0x00;
 433   1        g_scArrTxComSoft[8]=0xb0;
 434   1        g_scArrTxComSoft[9]=Sector;
 435   1        g_scArrTxComSoft[10]=Bloque;
 436   1        g_scArrTxComSoft[11]=0x01;
 437   1        g_scArrTxComSoft[12]=ETX;
 438   1      
 439   1        for (j=0; j<13; j++)
 440   1        {
 441   2          bcc=g_scArrTxComSoft[j]^bcc;
 442   2        }
 443   1        g_scArrTxComSoft[13]=bcc;
 444   1      
 445   1      
 446   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 447   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 448   1          DebugBufferMF(g_scArrTxComSoft,14,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 449   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,14);   /* envio la trama por el pto serie*/
 450   1          ValTimeOutCom=TIME_CARD;
 451   1      
 452   1      }
 453          
 454          /*------------------------------------------------------------------------------
 455          Funcion q lescribe la MF dandole el sector y el bloque y los datos
 456          ------------------------------------------------------------------------------*/
 457          
 458          
 459          void WR_MF(unsigned char Sector, unsigned char Bloque,unsigned char *buffer)     
 460             
 461          {
 462   1        unsigned char j, bcc;
 463   1        unsigned char g_scArrTxComSoft[31];
 464   1        bcc=0;
 465   1      
 466   1        Debug_txt_Tibbo((unsigned char *) "Escribe MF > Sector: ");
 467   1        Debug_chr_Tibbo(Sector);
 468   1        
 469   1        Debug_txt_Tibbo((unsigned char *) " Bloque: ");
 470   1        Debug_chr_Tibbo(Bloque);
 471   1        Debug_txt_Tibbo((unsigned char *) "\r\n");
 472   1                                          
 473   1        g_scArrTxComSoft[0]=0xF2;
 474   1        g_scArrTxComSoft[1]=0X00;                   
 475   1        g_scArrTxComSoft[2]=0X00;
 476   1        g_scArrTxComSoft[3]=24;                                 /* Numero Datos a programar */ 
 477   1        
 478   1        g_scArrTxComSoft[4]='C';
 479   1        g_scArrTxComSoft[5]=0X60;
 480   1        g_scArrTxComSoft[6]='3';
 481   1        g_scArrTxComSoft[7]=0x00;
 482   1        g_scArrTxComSoft[8]=0xd1;
 483   1        g_scArrTxComSoft[9]=Sector;                             //Sector;
 484   1        g_scArrTxComSoft[10]=Bloque;                            //Bloque;
 485   1        g_scArrTxComSoft[11]=0x01;
 486   1      
 487   1          for (j=0; j<=16; ++j)
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 09:24:08 PAGE 9   

 488   1            {
 489   2              g_scArrTxComSoft[j+12]=*(buffer + j); 
 490   2            }
 491   1        
 492   1        g_scArrTxComSoft[28]=ETX;
 493   1        
 494   1        for (j=0; j<=28; j++)
 495   1        {
 496   2          bcc=bcc^g_scArrTxComSoft[j];
 497   2        }
 498   1        g_scArrTxComSoft[29]=bcc;
 499   1      
 500   1        
 501   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 502   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 503   1          DebugBufferMF(g_scArrTxComSoft,30,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 504   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,30);   /* envio la trama por el pto serie*/
 505   1          ValTimeOutCom=TIME_CARD;
 506   1        
 507   1      }
 508          //*******************************************************************************************
 509          // rutina q mira el tipo de tarjeta si es valido para el uso  
 510          //*******************************************************************************************
 511          
 512          void Unique_Identifier_UID(void)
 513          {
 514   1      unsigned char j, bcc;
 515   1      unsigned char g_scArrTxComSoft[10];
 516   1            bcc=0;
 517   1        
 518   1        Debug_txt_Tibbo((unsigned char *) "UID\r\n");
 519   1        
 520   1        g_scArrTxComSoft[0]=STX_LINTECH;
 521   1          g_scArrTxComSoft[1]=0X00;
 522   1          g_scArrTxComSoft[2]=0X00;
 523   1          g_scArrTxComSoft[3]=0X05;
 524   1          g_scArrTxComSoft[4]='C';
 525   1          g_scArrTxComSoft[5]=0x60;
 526   1          g_scArrTxComSoft[6]=0x30;
 527   1          g_scArrTxComSoft[7]=0x41;
 528   1          g_scArrTxComSoft[8]=0x30;
 529   1          g_scArrTxComSoft[9]=ETX;
 530   1            for (j=0; j<10; j++)
 531   1          {
 532   2            bcc=g_scArrTxComSoft[j]^bcc;
 533   2          }
 534   1          g_scArrTxComSoft[10]=bcc;
 535   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 536   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 537   1          DebugBufferMF(g_scArrTxComSoft,11,0);               /*muestra la trama enviada al pto serie a debug por tibbo*/
 538   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,11);   /* envio la trama por el pto serie*/
 539   1          ValTimeOutCom=TIME_CARD;
 540   1        } 
 541          void Power_off(void)
 542          {
 543   1      unsigned char j, bcc;
 544   1      unsigned char g_scArrTxComSoft[10];
 545   1            bcc=0;
 546   1        
 547   1        Debug_txt_Tibbo((unsigned char *) "POWER OFF UID\r\n");
 548   1        
 549   1        g_scArrTxComSoft[0]=STX_LINTECH;
C51 COMPILER V9.59.0.0   LINTECH                                                           10/01/2020 09:24:08 PAGE 10  

 550   1          g_scArrTxComSoft[1]=0X00;
 551   1          g_scArrTxComSoft[2]=0X00;
 552   1          g_scArrTxComSoft[3]=0X03;
 553   1          g_scArrTxComSoft[4]='C';
 554   1          g_scArrTxComSoft[5]=0x60;
 555   1          g_scArrTxComSoft[6]=0x31;
 556   1          g_scArrTxComSoft[7]=ETX;
 557   1            for (j=0; j<8; j++)
 558   1          {
 559   2            bcc=g_scArrTxComSoft[j]^bcc;
 560   2          }
 561   1          g_scArrTxComSoft[8]=bcc;
 562   1          buffer_ready=0;                                   /* buffer del pto serie (0) inicia a esperar la trama*/
 563   1          g_cEstadoComSoft=ESPERA_RX;                       /* Espera el ASK en el pt o serie para empesar a almacenas*/
 564   1          DebugBufferMF(g_scArrTxComSoft,9,0);                /*muestra la trama enviada al pto serie a debug por tibbo*/
 565   1          EscribirCadenaSoft_buffer(g_scArrTxComSoft,9);    /* envio la trama por el pto serie*/
 566   1          ValTimeOutCom=TIME_CARD;
 567   1      
 568   1      
 569   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1987    ----
   CONSTANT SIZE    =    378    ----
   XDATA SIZE       =   ----     193
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
